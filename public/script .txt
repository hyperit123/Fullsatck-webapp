// JavaScript Document
// Wounds input logic and checkbox generation
let numberOfWounds = document.querySelector(`.stat-edit #tn`); // changed to tn in the overly
let woundsmod = document.getElementById("wounds-mod"); // Wounds modifier in the overly
let woundsContainer = document.getElementById("wounds").getElementsByClassName("check-boxs")[0];

function updateWounds() {
    let desiredWounds = Math.max((parseInt(numberOfWounds.value) || 0) * parseInt(woundsmod.value), 2);
    woundsContainer.innerHTML = '';
    for (let i = 0; i < desiredWounds; i++) {
        let checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        woundsContainer.appendChild(checkbox);
    }
}

numberOfWounds.addEventListener('input', function() {
    updateWounds();
});

woundsmod.addEventListener('input', function() {
    updateWounds();
});

// Stamina input logic and checkbox generation
let numberOfstamina = document.querySelector(`.stat-edit #dex`); // changed to dex in the overly
let staminamod = document.getElementById("stamina-mod"); // Stamina modifier in the overly
let staminaContainer = document.getElementById("stamina").getElementsByClassName("check-boxs")[0];

function updatestamina() {
    let desiredStamina = Math.max((parseInt(numberOfstamina.value) || 0) * parseInt(staminamod.value), 1);
    staminaContainer.innerHTML = '';
    for (let i = 0; i < desiredStamina; i++) {
        let checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        staminaContainer.appendChild(checkbox);
    }
}

numberOfstamina.addEventListener('input', function() {
    updatestamina();
});

staminamod.addEventListener('input', function() {
    updatestamina();
});

// Tab grup actions
const actionsTab = document.getElementById('actionsTab');
const traitsTab = document.getElementById('traitsTab');
const inventoryTab = document.getElementById('inventoryTab');
const actions = document.getElementById('Actions');
const traits = document.getElementById('Traits');
const inventory = document.getElementById('Inventory');

const updateTabs = (activeTab) => {
    actions.classList.remove('active');
    traits.classList.remove('active');
    inventory.classList.remove('active');
    actionsTab.classList.remove('active');
    traitsTab.classList.remove('active');
    inventoryTab.classList.remove('active');

    document.getElementById(activeTab).classList.toggle('active');
    document.getElementById(`${activeTab.toLowerCase()}Tab`).classList.toggle('active');
};

actionsTab.addEventListener('click', () => updateTabs('Actions'));
traitsTab.addEventListener('click', () => updateTabs('Traits'));
inventoryTab.addEventListener('click', () => updateTabs('Inventory'));

updateTabs('Actions'); // Set initial active tab

// Text Box Addition Logic
function addTabs(section) {
    let sectionContainer = document.getElementById(section.toLowerCase() + '-container');
    let boxIndex = (sectionContainer.getElementsByClassName('text-box').length).valueOf() + 1;
    let textBox = document.createElement('textarea');
    textBox.rows = 2;
    textBox.cols = 30;
    textBox.className = 'text-box';
    textBox.placeholder = `${section} ${boxIndex}`;
    textBox.id = `${section}-textbox-${boxIndex}`;

    // Create delete button
    let deleteBtn = document.createElement('button');
    deleteBtn.textContent = "X";
    deleteBtn.className = "delete-btn";

    // Wrap textarea + button together
    let wrapper = document.createElement('div');
    wrapper.className = "textbox-wrapper";
    wrapper.appendChild(textBox);
    wrapper.appendChild(deleteBtn);

    // Add delete functionality
    deleteBtn.addEventListener('click', () => {
        sectionContainer.removeChild(wrapper);
    });

    // Append wrapper to container
    sectionContainer.appendChild(wrapper);
}
// Actions Section
    let addActionButton = document.getElementById('add-action-button');
    addActionButton.addEventListener('click', () => {
        addTabs('actions');
    });
// bunus Actions Section
    let addBonusActionButton = document.getElementById('add-bonus-action-button');
    addBonusActionButton.addEventListener('click', () => {
        addTabs('bonus-actions');
    });
// Other Section
    let addOtherButton = document.getElementById('add-other-button');
    addOtherButton.addEventListener('click', () => {
        addTabs('other');
    });
// tarits Section
    let addTraitButton = document.getElementById('add-trait-button');
    addTraitButton.addEventListener('click', () => {
        addTabs('traits');
    });
// resistances Section
    let addResistencesButton = document.getElementById('add-resistences-button');
    addResistencesButton.addEventListener('click', () => {
        addTabs('resistances');
    });
// immunities Section
    let addImmunitiesButton = document.getElementById('add-immunities-button');
    addImmunitiesButton.addEventListener('click', () => {
        addTabs('immunities');
    });
// weaknesses Section
    let addWeaknessesButton = document.getElementById('add-weaknesses-button');
    addWeaknessesButton.addEventListener('click', () => {
        addTabs('weaknesses');
    });
// invertory Section
    let addInventoryButton = document.getElementById('add-inventory-button');
    addInventoryButton.addEventListener('click', () => {
        addTabs('inventory');
    });

// overly edit menu logic
let editbtn = document.getElementById("edit-btn");
let overly = document.getElementById("overly");

editbtn.addEventListener("click", function() {
    overly.style.display = "flex";
});

window.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
        if (window.getComputedStyle(overly).display === "flex") {
            overly.style.display = "none";
        }
    }
});

// name edit logic
let chnEdit = document.getElementById("chn-edit");
let chn = document.getElementById("chn");

chnEdit.addEventListener("input", () => {
    updatechn();
});

function updatechn(){
    chn.value = chnEdit.value;
}

// gender edit logic
let genderEdit = document.getElementById("gender-edit");
let gender = document.getElementById("gender");

genderEdit.addEventListener("change", () => {
    updategender();
});
function updategender() {
    gender.value = genderEdit.value;
}

// race edit logic
let raceEdit = document.getElementById("race-edit");
let race = document.getElementById("race");
let corentrace = "false";
let raceOrganic = raceEdit.options[raceEdit.selectedIndex].dataset.organic === "true";
let organic = document.getElementsByClassName("organic");
let mech = document.getElementsByClassName("mech");
raceEdit.addEventListener("change", () => {
    updaterace();
});

function updaterace() {
    const opt = raceEdit.options[raceEdit.selectedIndex];

    // keep your original behavior
    race.value = raceEdit.value; 

     // read the tag
    const isOrganic = opt.dataset.organic === "true";

    // use it however you like
    corentrace = isOrganic ? "true" : "false" ; // or clanker says Victor
    race.dataset.organic = isOrganic; // optional: store on the input for later

    // show/hide elements based on race
    if (corentrace === "true") {
        showorganic();
    }
    if (corentrace === "false"){
        showmech();
    }
}

function showorganic(){
    for (let i = 0; i < organic.length; i++) {
        organic[i].style.display = "block";
    }
    for (let i = 0; i < mech.length; i++) {
        mech[i].style.display = "none";
    }
}

function showmech(){
    for (let i = 0; i < mech.length; i++) {
        mech[i].style.display = "block";
    }
    for (let i = 0; i < organic.length; i++) {
        organic[i].style.display = "none";
    }
}

// class edit logic
let classEdit = document.getElementById("class-edit");
let classField = document.getElementById("class");

classEdit.addEventListener("change", () => {
    updateclass();
});

function updateclass() {
    classField.value = classEdit.value;
}

// background edit logic
let backgroundEdit = document.getElementById("background-edit");
let background = document.getElementById("background");

backgroundEdit.addEventListener("change", () => {
    updatebackground();
});

function updatebackground() {
    background.value = backgroundEdit.value;
}

// stats
let stats = ['ws', 'bs', 'str', 'tn', 'dex', 'per', 'int', 'wp', 'fel'];
let basePoints = 9; // points at level 1

// Sync display (.stat) with editable (.stat-edit)
stats.forEach((stat) => {
    const currentStat     = document.querySelector(`.stat #${stat}`);
    const currentStatEdit = document.querySelector(`.stat-edit #${stat}`);

    if (!currentStat || !currentStatEdit) {
        console.warn(`Missing element for stat: ${stat}`);
        return;
    }

    // Start at 1 if empty or less than 1
    currentStat.value     = Math.max(1, parseInt(currentStat.value) || 1);
    currentStatEdit.value = Math.max(1, parseInt(currentStatEdit.value) || 1);

    // Keep them in sync while typing
    currentStatEdit.addEventListener("input", () => {
        currentStat.value = currentStatEdit.value;
        calculatePoints(); // recalc points on change
    });

    // Enforce minimum only when leaving the field
    currentStatEdit.addEventListener("blur", () => {
        let newValue = parseInt(currentStatEdit.value) || 1;
        if (newValue < 1) newValue = 1;
        currentStatEdit.value = newValue;
        currentStat.value = newValue;
        calculatePoints();
    });
});

// level functionality
let exstrapoints = 0;
const levelInput = document.querySelector("#level-change");
let point = document.getElementById('points-remaining');
let expoint = document.getElementById('Exstra-points');

expoint.addEventListener("input", () => {
    exstrapoints = parseInt(expoint.value) || 0;
    calculatePoints(); // recalc whenever extra points change
    
});

let warned = false;

function calculatePoints() {
    let spentPoints = 0;
    const level = parseInt(levelInput.value) || 1;
    let totalPoints = basePoints + (level - 1) + exstrapoints;
    exstrapoints = parseInt(expoint.value) || 0;

    stats.forEach(stat => {
        const input = document.querySelector(`.stat-edit #${stat}`);
        let value = parseInt(input.value) || 1;
        if (value < 1) value = 1;
        input.value = value;
        spentPoints += (value - 1);
    });

    const remaining = totalPoints - spentPoints;
    point.value = remaining;

    if (remaining < 0 && !warned) {
        alert("You have spent too many points!");
        warned = true; // prevent further alerts
    }
    if (remaining >= 0) {
        warned = false; // reset when valid again
    }
}


// Attach listeners for level changes
levelInput.addEventListener("input", calculatePoints);

// Initialize
calculatePoints();


// level changing
let currentlevel = document.getElementById('level-change')
let levelvalue = document.getElementById('level-value')
currentlevel.addEventListener("input", () => {
    levelload();
});
function levelload() {
    levelvalue.value = currentlevel.value
}

// Initial generation on page load
document.addEventListener("DOMContentLoaded", () => {
    pagereload();
});

function safeCall(fn) {
    try {
        fn();
    } catch (e) {
        console.error("Error in function:", fn.name, e);
    }
}

// checkbox adding
let addcheckbox = document.getElementById("add-check-box");
let checkboxs = document.getElementById("check-boxs");
let totalcheckboxs = 0;

addcheckbox.addEventListener("click", function() {
    totalcheckboxs += 1;

    // Container for each "check-boxs"
    let chbc = document.createElement('div');
    chbc.className = "check-boxs-container";
    chbc.style = 'display: grid; grid-template-columns: 60% 20%; gap: 10px;'
    checkboxs.appendChild(chbc);

    // Label input
    let inputforchc = document.createElement('input');
    inputforchc.placeholder = `check box ${totalcheckboxs}`;
    inputforchc.className = 'check-box-exstras';
    chbc.appendChild(inputforchc);

    // Number input (to decide how many checkboxes to add)
    let inputval = document.createElement('input');
    inputval.type = 'number';
    inputval.value = 1;
    inputval.min = 1;
    inputval.max = 40;
    inputval.className = 'inputval';
    chbc.appendChild(inputval);

    // Div to hold the checkboxes
    let div = document.createElement('div');
    div.className = 'check-boxs';
    chbc.appendChild(div);

    // Function to update checkboxes based on inputval
    function updateexstra() {
        let desiredWounds = parseInt(inputval.value) || 0;
        div.innerHTML = ''; // clear old checkboxes
        for (let i = 0; i < desiredWounds; i++) {
            let checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            div.appendChild(checkbox);
        }
    }
    updateexstra();

    // Update whenever the number input changes
    inputval.addEventListener('input', updateexstra);

    console.log("added check box container thing");
});


function pagereload() {
    safeCall(updateWounds);
    safeCall(updatestamina);
    safeCall(updategender);
    safeCall(updaterace);
    safeCall(updateclass);
    safeCall(updatebackground);
    safeCall(updatechn)
    safeCall(levelload)
    safeCall(calculatePoints)
}

// End of script.js